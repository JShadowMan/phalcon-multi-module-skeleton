<?php
/**
 * This file is part of phalcon-skeleton
 *
 * @copyright Copyright (C) 2020 Jayson Wang
 * @license   MIT License
 * @link      https://github.com/lsalio/phalcon-skeleton
 */
namespace App\Library\Framework\Config;

use App\Library\Framework\Exception\Runtime\InvalidParameterException;
use League\Flysystem\Filesystem;
use Phalcon\Config;


/**
 * Class Factory
 * @package App\Library\Framework\Config
 */
class Factory {

    /**
     * The name of the service
     *
     * @var string
     */
    protected $name;

    /**
     * The callable to load config
     *
     * @var callable|string|array
     */
    protected $loader;

    /**
     * The prefix string of cache filename
     *
     * @var string
     */
    protected static $prefix = '__';

    /**
     * The suffix string of cache filename
     *
     * @var string
     */
    protected static $suffix = '__';

    /**
     * Factory constructor.
     *
     * @param string $name The name of the factory and using cache filename
     * @param callable|string|array $loader The loader receive an string of relative path to load and returns a array
     * @throws InvalidParameterException
     */
    public function __construct(string $name, $loader = 'config_path') {
        $this->name = join('', [self::$prefix, $name, self::$suffix]);
        $this->loader = $loader;
        if (!is_callable($this->loader)) {
            throw new InvalidParameterException("The loader except callable");
        }
    }

    /**
     * Load all modules and returns a config
     *
     * @param array $configs
     * @return Config
     */
    public function load(array $configs = []): Config {
        $config = new Config();
        $basedir = cache_path(env('STORAGE_CACHE_CONFIG_PATH', 'config'));

        /* @var $filesystem Filesystem */
        $filesystem = container('filesystem', $basedir);
        if ($filesystem->has("{$this->name}.php") && !environment('development')) {
            return static::merge($config, $basedir . "/{$this->name}.php");
        }

        foreach ($configs as $cfg) {
            static::merge($config, $this->buildPath("{$cfg}.php"), ($cfg === 'config' ? null : $cfg));
        }

        static::dump($filesystem, "{$this->name}.php", $config->toArray());
        return $config;
    }

    /**
     * Returns the string of the absolute path to import
     *
     * @param string $path
     * @return string
     */
    protected function buildPath(string $path = ''): string {
        return call_user_func($this->loader, $path);
    }

    /**
     * Merge other configure to main object
     *
     * @param Config $config
     * @param string $path
     * @param string|null $mount
     * @return Config
     */
    private static function merge(Config $config, string $path, ?string $mount = null): Config {
        /** @noinspection PhpIncludeInspection */
        $value = include $path;
        if (is_array($value)) {
            $value = new Config($value);
        }

        if ($value instanceof Config) {
            if (!$mount) {
                return $config->merge($value);
            }
            $config[$mount] = (new Config())->merge($value);
        }
        return $config;
    }

    /**
     * Dump the configure to cache file
     *
     * @param Filesystem $filesystem
     * @param string $file
     * @param array $data
     */
    private static function dump(Filesystem $filesystem, string $file, array $data): void {
        $contents = '<?php' . PHP_EOL
            . '/* !! PLEASE DO NOT EDIT THIS FILE DIRECTLY !! */' . PHP_EOL
            . 'return ' . var_export($data, true) . ';' . PHP_EOL;
        $filesystem->put($file, $contents, $data);
    }

}
